{"title":"关于getDeviceId和getImei获取值不同的分析","date":"2020-03-22T13:29:09.000Z","slug":"android-get-imei","comments":true,"tags":["Android"],"categories":["技术栈"],"updated":"2020-03-22T13:39:14.338Z","content":"<h2 id=\"问题背景\"><a href=\"#问题背景\" class=\"headerlink\" title=\"问题背景\"></a>问题背景</h2><p>需要获取imei的值，很容易查询到使用TelephonyManager的getDeviceId()（在API Level 26 以上已标记为@Deprecated，在很多Android 26以上设备上也可继续使用）方法和getImei()方法（注释标记该方法需在API Level 26 以上调用，不过实测在有些26以下设备也可以调用到）<br><code>Tips:Android Q 以上获取imei的需要READ_PRIVILEGED_PHONE_STATE 权限，该权限只有系统应用可以获取，普通应用使用以上两种方法获取均会抛出异常SecurityException，不过本文这不是重点，所以本文指的是Android Q以下相关设备。</code><br>网上的说法这两个都是获取imei的方法，是使用的API Level不同，所以使用时一直以为如果遇到两个方法都能获取到值的情况，两个值应该相同，都是imei的值。<br>近期发现getDeviceId()和getImei()同时可用时获取到的值有时会不同，故跟踪一下源码查看一下区别，在此记录。  </p>\n<h2 id=\"问题分析\"><a href=\"#问题分析\" class=\"headerlink\" title=\"问题分析\"></a>问题分析</h2><p>跟踪TelephonyManager的getDeviceId()和getImei()实现方法<br><a id=\"more\"></a></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div></pre></td><td class=\"code\"><pre><div class=\"line\">  <span class=\"comment\">//android/telephony/TelephonyManager.java</span></div><div class=\"line\">  <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getDeviceId</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">      <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">          ITelephony telephony = getITelephony();</div><div class=\"line\">          <span class=\"keyword\">if</span> (telephony == <span class=\"keyword\">null</span>)</div><div class=\"line\">              <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</div><div class=\"line\">          <span class=\"keyword\">return</span> telephony.getDeviceId(mContext.getOpPackageName());</div><div class=\"line\">      &#125; <span class=\"keyword\">catch</span> (RemoteException ex) &#123;</div><div class=\"line\">          <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</div><div class=\"line\">      &#125; <span class=\"keyword\">catch</span> (NullPointerException ex) &#123;</div><div class=\"line\">          <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</div><div class=\"line\">      &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getImei</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">      <span class=\"keyword\">return</span> getImei(getSlotIndex());</div><div class=\"line\">  &#125;</div><div class=\"line\">   <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getImei</span><span class=\"params\">(<span class=\"keyword\">int</span> slotIndex)</span> </span>&#123;</div><div class=\"line\">      ITelephony telephony = getITelephony();</div><div class=\"line\">      <span class=\"keyword\">if</span> (telephony == <span class=\"keyword\">null</span>) <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</div><div class=\"line\">      <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">          <span class=\"keyword\">return</span> telephony.getImeiForSlot(slotIndex, getOpPackageName(), getFeatureId());</div><div class=\"line\">      &#125; <span class=\"keyword\">catch</span> (RemoteException ex) &#123;</div><div class=\"line\">          <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</div><div class=\"line\">      &#125; <span class=\"keyword\">catch</span> (NullPointerException ex) &#123;</div><div class=\"line\">          <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</div><div class=\"line\">      &#125;</div><div class=\"line\">  &#125;</div></pre></td></tr></table></figure>\n<p>接下来的工作都是跟踪对应的类调用<br>getDeviceId():<br>PhoneInterfaceManager.java –&gt;getDeviceId(String callingPackage)<br>–&gt; getDeviceIdWithFeature(String callingPackage, String callingFeatureId)<br>–&gt;  PhoneFactory.getPhone(0).getDeviceId()<br>getImei():<br>PhoneInterfaceManager.java –&gt; getImeiForSlot(int slotIndex, String callingPackage, String callingFeatureId)<br>–&gt; PhoneFactory.getPhone(0).getImei()<br>PhoneInterfaceManager 作为TelephonyManager的 server 端，有很多方法，有兴趣的可以再深入了解。<br>最终获取的是Phone中的值，Phone phone = PhoneFactory.getPhone(0);<br>frameworks/opt/telephony/src/java/com/android/internal/telephony/Phone.java是一个抽象类,<br>对应的子类包括GsmCdmaPhone.java、ImsPhoneBase.java,SipPhoneBase.java,<br>通过命名大概能看出是手机应该使用的是GsmCdmaPhone.java,<br>也可以看到ImsPhoneBase.java,SipPhoneBase.java 关于getDeviceId()和getImei()的返回值均为null,<br>故只需关注GsmCdmaPhone.java即可</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//frameworks/opt/telephony/src/java/com/android/internal/telephony/GsmCdmaPhone.java</span></div><div class=\"line\"><span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getDeviceId</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">if</span> (isPhoneTypeGsm()) &#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> mImei;</div><div class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</div><div class=\"line\">        CarrierConfigManager configManager = (CarrierConfigManager)</div><div class=\"line\">                mContext.getSystemService(Context.CARRIER_CONFIG_SERVICE);</div><div class=\"line\">        <span class=\"keyword\">boolean</span> force_imei = configManager.getConfigForSubId(getSubId())</div><div class=\"line\">                .getBoolean(CarrierConfigManager.KEY_FORCE_IMEI_BOOL);</div><div class=\"line\">        <span class=\"keyword\">if</span> (force_imei) <span class=\"keyword\">return</span> mImei;</div><div class=\"line\">        String id = getMeid();</div><div class=\"line\">        <span class=\"keyword\">if</span> ((id == <span class=\"keyword\">null</span>) || id.matches(<span class=\"string\">\"^0*$\"</span>)) &#123;</div><div class=\"line\">            loge(<span class=\"string\">\"getDeviceId(): MEID is not initialized use ESN\"</span>);</div><div class=\"line\">            id = getEsn();</div><div class=\"line\">        &#125;</div><div class=\"line\">        <span class=\"keyword\">return</span> id;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"meta\">@Override</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getImei</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> mImei;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h2 id=\"结论\"><a href=\"#结论\" class=\"headerlink\" title=\"结论\"></a>结论</h2><p><strong>很明显，getImei()是纯粹获取imei值的方法，getDeviceId中包含判断，如果isPhoneTypeGsm() ==false &amp;&amp; force_imei = false 也可能获取meid或Esn作为返回值。</strong></p>\n","prev":{"title":"Kotlin学习笔记-延迟属性by lazy、lateinit、Delegates.notNull","slug":"kotlin-grasp-lazy-properties"},"next":{"title":"Kotlin学习笔记-较难理解的？","slug":"kotlin-grasp-question-mark"},"link":"http://ncmon.com/post/android-get-imei/","toc":[{"title":"问题背景","id":"问题背景","index":"1"},{"title":"问题分析","id":"问题分析","index":"2"},{"title":"结论","id":"结论","index":"3"}],"copyright":{"author":"ncmon","link":"<a href=\"http://ncmon.com/post/android-get-imei/\" title=\"关于getDeviceId和getImei获取值不同的分析\">http://ncmon.com/post/android-get-imei/</a>","license":"Attribution-NonCommercial-NoDerivatives 4.0 International (<a href=\"https://creativecommons.org/licenses/by-nc-sa/4.0/\" rel=\"external nofollow noopener\" target=\"_blank\">CC BY-NC-ND 4.0</a>)"},"reward":true}