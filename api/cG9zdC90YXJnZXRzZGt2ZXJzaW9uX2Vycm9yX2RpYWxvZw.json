{"title":"应用弹窗“此应用专为旧版Android打造，因此可能无法正常运行”","date":"2019-12-19T07:36:09.000Z","slug":"targetsdkversion_error_dialog","comments":true,"tags":["Android"],"categories":["技术栈"],"updated":"2020-01-05T12:41:18.363Z","content":"<h2 id=\"应用弹窗“此应用专为旧版Android打造，因此可能无法正常运行\"><a href=\"#应用弹窗“此应用专为旧版Android打造，因此可能无法正常运行\" class=\"headerlink\" title=\"应用弹窗“此应用专为旧版Android打造，因此可能无法正常运行\"></a>应用弹窗“此应用专为旧版Android打造，因此可能无法正常运行</h2><p>安装在新设备上的应用出现了这个警告弹窗：</p>\n<div class=\"article-img\"><p><img src=\"https://ncmon-blog.oss-cn-beijing.aliyuncs.com/targetsdk_error_dialog.png\" alt=\"targetsdk_error_dialog\"></p></div>\n<p>显然是个系统弹窗。看一下原因</p>\n<h3 id=\"Android源码分析\"><a href=\"#Android源码分析\" class=\"headerlink\" title=\"Android源码分析\"></a>Android源码分析</h3><p>追踪应用启动代码，忽略过程，本文不是重点，经过层层调用会进入到AppWarnings方法中，直接去看关键信息：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//com/android/server/wm/AppWarnings.java</span></div><div class=\"line\"><span class=\"comment\">/**</span></div><div class=\"line\"> * Shows the \"deprecated target sdk\" warning, if necessary.</div><div class=\"line\"> *</div><div class=\"line\"> * <span class=\"doctag\">@param</span> r activity record for which the warning may be displayed</div><div class=\"line\"> */</div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">showDeprecatedTargetDialogIfNeeded</span><span class=\"params\">(ActivityRecord r)</span> </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">if</span> (r.appInfo.targetSdkVersion &lt; Build.VERSION.MIN_SUPPORTED_TARGET_SDK_INT) &#123;</div><div class=\"line\">        mUiHandler.showDeprecatedTargetDialog(r);</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"comment\">/**</span></div><div class=\"line\"> * Called when an activity is being started.</div><div class=\"line\"> *</div><div class=\"line\"> * <span class=\"doctag\">@param</span> r record for the activity being started</div><div class=\"line\"> */</div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onStartActivity</span><span class=\"params\">(ActivityRecord r)</span> </span>&#123;</div><div class=\"line\">    showUnsupportedCompileSdkDialogIfNeeded(r);</div><div class=\"line\">    showUnsupportedDisplaySizeDialogIfNeeded(r);</div><div class=\"line\">    showDeprecatedTargetDialogIfNeeded(r);</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>可以看到该弹窗的显示位置showDeprecatedTargetDialogIfNeeded(ActivityRecord)只有一个条件：targetSdkVersion&lt;Build.VERSION.MIN_SUPPORTED_TARGET_SDK_INT<br>继续追踪Build.java</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\">//android/os/Build.java</span></div><div class=\"line\"><span class=\"comment\">/**</span></div><div class=\"line\"> * The current lowest supported value of app target SDK. Applications targeting</div><div class=\"line\"> * lower values may not function on devices running this SDK version. Its possible</div><div class=\"line\"> * values are defined in &#123;<span class=\"doctag\">@link</span> Build.VERSION_CODES&#125;.</div><div class=\"line\"> *</div><div class=\"line\"> * <span class=\"doctag\">@hide</span></div><div class=\"line\"> */</div><div class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> MIN_SUPPORTED_TARGET_SDK_INT = SystemProperties.getInt(</div><div class=\"line\">        <span class=\"string\">\"ro.build.version.min_supported_target_sdk\"</span>, <span class=\"number\">0</span>);</div></pre></td></tr></table></figure>\n<p>是设备中配置信息ro.build.version.min_supported_target_sdk<br>目前发现在Android P 和Android Q中会出现该问题，查看测试机型中该配置的值<br>Android Q设备中该值：</p>\n<div class=\"article-img\"><p><img src=\"https://ncmon-blog.oss-cn-beijing.aliyuncs.com/targetsdk_error_Q.png\" alt=\"targetsdk_error_Q\"></p></div>\n<p>Android P设备中该值：</p>\n<div class=\"article-img\"><p><img src=\"https://ncmon-blog.oss-cn-beijing.aliyuncs.com/targetsdk_error_P.png\" alt=\"targetsdk_error_P\"></p></div>\n<p>这里有一个问题，既然是在每个Activity启动时会调用AppWarnings.java的onStartActivity方法，<strong>那会不会每次打开新Activity，都弹此对话框？</strong></p>\n<p>答案：不会的，这里有一个小技巧，第一次弹出对话框后，用户如果选择“确定”，AMS会给此应用设置一个Flag标识：FLAG_HIDE_DEPRECATED_SDK。每次准备弹窗时，会先判断此标识值是否为true，如果是，说明已经提示过用户，无需再弹窗。代码如下：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">   <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">DeprecatedTargetSdkVersionDialog</span><span class=\"params\">(<span class=\"keyword\">final</span> AppWarnings manager, Context context, ApplicationInfo appInfo)</span> </span>&#123;</div><div class=\"line\"><span class=\"comment\">// ...</span></div><div class=\"line\"><span class=\"keyword\">final</span> AlertDialog.Builder builder = <span class=\"keyword\">new</span> AlertDialog.Builder(context)</div><div class=\"line\">.setPositiveButton(R.string.ok, (dialog, which) -&gt;</div><div class=\"line\">manager.setPackageFlag(mPackageName, AppWarnings.FLAG_HIDE_DEPRECATED_SDK, <span class=\"keyword\">true</span>))</div><div class=\"line\">.setMessage(message)</div><div class=\"line\">.setTitle(label);</div><div class=\"line\"><span class=\"comment\">// ...</span></div><div class=\"line\">   &#125;</div></pre></td></tr></table></figure>\n<h3 id=\"问题结论\"><a href=\"#问题结论\" class=\"headerlink\" title=\"问题结论\"></a>问题结论</h3><p><strong>结论很清晰：文章开头中提到的弹窗，在Android P设备中targetSdkVersion&lt;17的应用会弹出该弹窗，在Android Q设备中targetSdkVersion&lt;23的应用会弹出该弹窗。</strong></p>\n","next":{"title":"Android WebView必知必会(4)-Webview下载支持，与JavaScript的交互","slug":"webview-learning-JavaScript"},"link":"http://ncmon.com/post/targetsdkversion_error_dialog/","toc":[{"title":"应用弹窗“此应用专为旧版Android打造，因此可能无法正常运行","id":"应用弹窗“此应用专为旧版Android打造，因此可能无法正常运行","index":"1","children":[{"title":"Android源码分析","id":"Android源码分析","index":"1.1"},{"title":"问题结论","id":"问题结论","index":"1.2"}]}],"copyright":{"author":"ncmon","link":"<a href=\"http://ncmon.com/post/targetsdkversion_error_dialog/\" title=\"应用弹窗“此应用专为旧版Android打造，因此可能无法正常运行”\">http://ncmon.com/post/targetsdkversion_error_dialog/</a>","license":"Attribution-NonCommercial-NoDerivatives 4.0 International (<a href=\"https://creativecommons.org/licenses/by-nc-sa/4.0/\" rel=\"external nofollow noopener\" target=\"_blank\">CC BY-NC-ND 4.0</a>)"},"reward":true}